<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maize Admin - Teaching Assistant Management</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        .notification-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 12px 20px;
            text-align: center;
            font-weight: 500;
            z-index: 1000;
            transform: translateY(-100%);
            transition: transform 0.3s ease;
        }
        .notification-bar.show {
            transform: translateY(0);
        }
        .notification-bar.success {
            background: #22c55e;
            color: white;
        }
        .notification-bar.error {
            background: #ef4444;
            color: white;
        }
        .notification-bar.info {
            background: #3b82f6;
            color: white;
        }
        .notification-bar.warning {
            background: #f59e0b;
            color: white;
        }
        .indexing-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 16px;
        }
        .indexing-status.running {
            background: #dbeafe;
            color: #1d4ed8;
        }
        .indexing-status.failed {
            background: #fee2e2;
            color: #b91c1c;
        }
        .indexing-status.completed {
            background: #dcfce7;
            color: #166534;
        }
        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #3b82f6;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="notification-bar" class="notification-bar"></div>
    
    <div class="admin-container">
        <header class="admin-header">
            <h1><a href="/">Maize</a> Admin Panel</h1>
            <a href="/admin/logout" class="btn btn-secondary btn-sm">Logout</a>
        </header>
        
        <main id="admin-main" class="admin-main">
            <section class="ta-list-section">
                <div class="section-header">
                    <h2>Teaching Assistants</h2>
                    <button onclick="showCreateModal()" class="btn btn-primary">Create New TA</button>
                </div>
                <div id="ta-list" class="ta-list">
                    <p class="loading">Loading...</p>
                </div>
            </section>
            
            <section id="ta-detail" class="ta-detail-section" style="display: none;">
                <div class="section-header">
                    <h2 id="detail-title">TA Details</h2>
                    <button onclick="hideDetail()" class="btn btn-secondary">Back to List</button>
                </div>
                <div id="ta-detail-content"></div>
            </section>
        </main>
        
        <div id="create-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <span class="close" onclick="hideCreateModal()">&times;</span>
                <h2>Create New Teaching Assistant</h2>
                <form id="create-ta-form" onsubmit="createTA(event)">
                    <div class="form-group">
                        <label for="ta-slug">URL Path (slug):</label>
                        <input type="text" id="ta-slug" required placeholder="e.g., financecourse" pattern="[a-z0-9-]+" title="Lowercase letters, numbers, and hyphens only">
                        <small>This will be the URL path: /financecourse</small>
                    </div>
                    <div class="form-group">
                        <label for="ta-name">TA Name:</label>
                        <input type="text" id="ta-name" required placeholder="e.g., Finance 101 TA">
                    </div>
                    <div class="form-group">
                        <label for="ta-course">Course Name:</label>
                        <input type="text" id="ta-course" required placeholder="e.g., Introduction to Finance">
                    </div>
                    <div class="form-group">
                        <label for="ta-prompt">System Prompt (optional):</label>
                        <textarea id="ta-prompt" rows="4" placeholder="Custom instructions for the TA..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Create TA</button>
                </form>
            </div>
        </div>
    </div>
    
    <script>
        let currentTaId = null;
        let indexingPollInterval = null;
        
        function showNotification(message, type = 'info', duration = 5000) {
            const bar = document.getElementById('notification-bar');
            bar.textContent = message;
            bar.className = 'notification-bar ' + type + ' show';
            
            setTimeout(() => {
                bar.classList.remove('show');
            }, duration);
        }
        
        function getStatusDisplay(ta) {
            if (ta.indexing_status === 'running') {
                return '<span class="status indexing">Indexing...</span>';
            } else if (ta.is_indexed) {
                return '<span class="status indexed">Ready</span>';
            } else {
                return '<span class="status not-indexed">Not Indexed</span>';
            }
        }
        
        function loadTAs() {
            fetch('/admin/api/tas')
            .then(res => res.json())
            .then(tas => {
                const list = document.getElementById('ta-list');
                if (tas.length === 0) {
                    list.innerHTML = '<p class="empty">No teaching assistants yet. Create your first one!</p>';
                    return;
                }
                
                list.innerHTML = tas.map(ta => `
                    <div class="ta-card" onclick="showTADetail('${ta.id}')">
                        <h3>${ta.name}</h3>
                        <p class="course-name">${ta.course_name}</p>
                        <p class="ta-slug">/${ta.slug}</p>
                        <div class="ta-meta">
                            ${getStatusDisplay(ta)}
                            <span class="doc-count">${ta.document_count} documents</span>
                        </div>
                    </div>
                `).join('');
            });
        }
        
        function showTADetail(taId) {
            fetch(`/admin/api/tas/${taId}`)
            .then(res => res.json())
            .then(ta => {
                document.getElementById('ta-list-section') && 
                    (document.querySelector('.ta-list-section').style.display = 'none');
                document.getElementById('ta-detail').style.display = 'block';
                document.getElementById('detail-title').textContent = ta.name;
                
                const docsHtml = ta.documents.length > 0 
                    ? ta.documents.map(doc => `
                        <div class="doc-item">
                            <span class="doc-name">${doc.filename}</span>
                            <span class="doc-type">${doc.doc_type || 'unknown'}</span>
                            <button onclick="deleteDocument('${ta.id}', ${doc.id})" class="btn btn-small btn-danger">Delete</button>
                        </div>
                    `).join('')
                    : '<p class="empty">No documents uploaded yet.</p>';
                
                let indexingStatusHtml = '';
                if (ta.indexing_status === 'running') {
                    indexingStatusHtml = `<div class="indexing-status running"><div class="spinner"></div> Indexing in progress...</div>`;
                    startIndexingPoll(ta.id);
                } else if (ta.indexing_status === 'failed') {
                    indexingStatusHtml = `<div class="indexing-status failed">Indexing failed: ${ta.indexing_error || 'Unknown error'}</div>`;
                } else if (ta.indexing_status === 'completed') {
                    indexingStatusHtml = `<div class="indexing-status completed">Indexing completed successfully</div>`;
                }
                
                const indexBtnDisabled = ta.document_count === 0 || ta.indexing_status === 'running';
                const indexBtnText = ta.indexing_status === 'running' ? 'Indexing...' : (ta.is_indexed ? 'Re-index Documents' : 'Index Documents');
                
                document.getElementById('ta-detail-content').innerHTML = `
                    ${indexingStatusHtml}
                    <div class="detail-info">
                        <p><strong>Course:</strong> ${ta.course_name}</p>
                        <p><strong>Status:</strong> ${ta.is_indexed ? 'Ready' : 'Needs Indexing'}</p>
                        <p><strong>Documents:</strong> ${ta.document_count}</p>
                    </div>
                    
                    <div class="slug-section">
                        <h3>URL Path</h3>
                        <div class="slug-edit-group">
                            <span class="slug-prefix">/</span>
                            <input type="text" id="ta-slug-edit" value="${ta.slug}" pattern="[a-z0-9-]+" title="Lowercase letters, numbers, and hyphens only">
                            <button onclick="updateSlug('${ta.id}')" class="btn btn-secondary">Update URL</button>
                        </div>
                        <p class="slug-hint">Current URL: <a href="/${ta.slug}" target="_blank">/${ta.slug}</a></p>
                        <p id="slug-status"></p>
                    </div>
                    
                    <div class="upload-section">
                        <h3>Upload Documents</h3>
                        <div class="drop-zone" id="drop-zone" onclick="document.getElementById('doc-files').click()">
                            <input type="file" id="doc-files" multiple accept=".pdf,.docx,.doc,.xlsx,.xls,.txt,.pptx,.ppt" style="display:none" onchange="handleFileSelect(event, '${ta.id}')">
                            <div class="drop-zone-content">
                                <svg class="drop-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="17 8 12 3 7 8"></polyline>
                                    <line x1="12" y1="3" x2="12" y2="15"></line>
                                </svg>
                                <p class="drop-text">Drag & drop files here or click to browse</p>
                                <p class="drop-hint">PDF, DOCX, XLSX, TXT, PPTX supported</p>
                            </div>
                        </div>
                        <div id="upload-progress" class="upload-progress"></div>
                    </div>
                    
                    <div class="documents-section">
                        <h3>Documents</h3>
                        <div class="documents-list">${docsHtml}</div>
                    </div>
                    
                    <div class="actions-section">
                        <button onclick="reindexTA('${ta.id}')" class="btn btn-primary" ${indexBtnDisabled ? 'disabled' : ''}>
                            ${indexBtnText}
                        </button>
                        <button onclick="deleteTA('${ta.id}')" class="btn btn-danger">Delete TA</button>
                    </div>
                    
                    <div class="prompt-section">
                        <h3>System Prompt</h3>
                        <textarea id="system-prompt" rows="6">${ta.system_prompt}</textarea>
                        <button onclick="updatePrompt('${ta.id}')" class="btn btn-secondary">Update Prompt</button>
                    </div>
                `;
                currentTaId = ta.id;
                setTimeout(setupDropZone, 0);
            });
        }
        
        function hideDetail() {
            document.getElementById('ta-detail').style.display = 'none';
            document.querySelector('.ta-list-section').style.display = 'block';
            loadTAs();
        }
        
        function showCreateModal() {
            document.getElementById('create-modal').style.display = 'flex';
        }
        
        function hideCreateModal() {
            document.getElementById('create-modal').style.display = 'none';
        }
        
        function createTA(e) {
            e.preventDefault();
            
            const data = {
                slug: document.getElementById('ta-slug').value,
                name: document.getElementById('ta-name').value,
                course_name: document.getElementById('ta-course').value,
                system_prompt: document.getElementById('ta-prompt').value || undefined
            };
            
            fetch('/admin/api/tas', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(res => res.json())
            .then(result => {
                if (result.error) {
                    showNotification(result.error, 'error');
                } else {
                    hideCreateModal();
                    document.getElementById('create-ta-form').reset();
                    showNotification('Teaching Assistant created successfully!', 'success');
                    loadTAs();
                }
            });
        }
        
        function setupDropZone() {
            const dropZone = document.getElementById('drop-zone');
            if (!dropZone) return;
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.add('drop-zone-active'), false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.remove('drop-zone-active'), false);
            });
            
            dropZone.addEventListener('drop', (e) => {
                const files = e.dataTransfer.files;
                if (files.length > 0 && currentTaId) {
                    uploadFiles(files, currentTaId);
                }
            }, false);
        }
        
        function handleFileSelect(e, taId) {
            const files = e.target.files;
            if (files.length > 0) {
                uploadFiles(files, taId);
            }
        }
        
        async function uploadFiles(files, taId) {
            const progressContainer = document.getElementById('upload-progress');
            progressContainer.innerHTML = '';
            
            const fileArray = Array.from(files);
            let successCount = 0;
            let errorCount = 0;
            
            for (let i = 0; i < fileArray.length; i++) {
                const file = fileArray[i];
                const fileId = `file-${i}`;
                
                progressContainer.innerHTML += `
                    <div class="upload-item" id="${fileId}">
                        <span class="upload-filename">${file.name}</span>
                        <span class="upload-status uploading">Uploading...</span>
                    </div>
                `;
                
                const formData = new FormData();
                formData.append('file', file);
                
                try {
                    const res = await fetch(`/admin/api/tas/${taId}/upload`, {
                        method: 'POST',
                        body: formData
                    });
                    const result = await res.json();
                    
                    const statusEl = document.querySelector(`#${fileId} .upload-status`);
                    if (result.error) {
                        statusEl.textContent = result.error;
                        statusEl.className = 'upload-status error';
                        errorCount++;
                    } else {
                        statusEl.textContent = 'Done';
                        statusEl.className = 'upload-status success';
                        successCount++;
                    }
                } catch (err) {
                    const statusEl = document.querySelector(`#${fileId} .upload-status`);
                    statusEl.textContent = 'Failed';
                    statusEl.className = 'upload-status error';
                    errorCount++;
                }
            }
            
            document.getElementById('doc-files').value = '';
            
            if (successCount > 0) {
                setTimeout(() => showTADetail(taId), 1000);
            }
        }
        
        function deleteDocument(taId, docId) {
            if (!confirm('Delete this document?')) return;
            
            fetch(`/admin/api/tas/${taId}/documents/${docId}`, {
                method: 'DELETE'
            })
            .then(() => showTADetail(taId));
        }
        
        function reindexTA(taId) {
            if (!confirm('This will process all documents and create the search index. Continue?')) return;
            
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = 'Starting...';
            
            fetch(`/admin/api/tas/${taId}/reindex`, {
                method: 'POST'
            })
            .then(res => res.json())
            .then(result => {
                if (result.error) {
                    showNotification(`Indexing failed: ${result.error}`, 'error');
                    showTADetail(taId);
                } else {
                    showNotification('Indexing started in the background. You can continue working.', 'info', 8000);
                    startIndexingPoll(taId);
                }
            })
            .catch(err => {
                showNotification('Failed to start indexing', 'error');
                showTADetail(taId);
            });
        }
        
        function startIndexingPoll(taId) {
            if (indexingPollInterval) {
                clearInterval(indexingPollInterval);
            }
            
            indexingPollInterval = setInterval(() => {
                fetch(`/admin/api/tas/${taId}/indexing-status`)
                .then(res => res.json())
                .then(status => {
                    if (status.status === 'completed') {
                        clearInterval(indexingPollInterval);
                        indexingPollInterval = null;
                        showNotification('Indexing completed successfully!', 'success');
                        if (currentTaId === taId) {
                            showTADetail(taId);
                        }
                        loadTAs();
                    } else if (status.status === 'failed') {
                        clearInterval(indexingPollInterval);
                        indexingPollInterval = null;
                        showNotification(`Indexing failed: ${status.error}`, 'error', 10000);
                        if (currentTaId === taId) {
                            showTADetail(taId);
                        }
                        loadTAs();
                    }
                })
                .catch(err => {
                    console.error('Error polling indexing status:', err);
                });
            }, 3000);
        }
        
        function deleteTA(taId) {
            if (!confirm('Delete this teaching assistant? This cannot be undone.')) return;
            
            fetch(`/admin/api/tas/${taId}`, {
                method: 'DELETE'
            })
            .then(() => {
                showNotification('Teaching Assistant deleted', 'success');
                hideDetail();
            });
        }
        
        function updatePrompt(taId) {
            const prompt = document.getElementById('system-prompt').value;
            
            fetch(`/admin/api/tas/${taId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ system_prompt: prompt })
            })
            .then(res => res.json())
            .then(result => {
                if (result.success) {
                    showNotification('System prompt updated!', 'success');
                }
            });
        }
        
        function updateSlug(taId) {
            const newSlug = document.getElementById('ta-slug-edit').value.trim().toLowerCase().replace(/\s+/g, '-');
            const statusEl = document.getElementById('slug-status');
            
            if (!newSlug) {
                statusEl.textContent = 'URL path cannot be empty';
                statusEl.style.color = '#ef4444';
                return;
            }
            
            if (!/^[a-z0-9-]+$/.test(newSlug)) {
                statusEl.textContent = 'Only lowercase letters, numbers, and hyphens allowed';
                statusEl.style.color = '#ef4444';
                return;
            }
            
            statusEl.textContent = 'Updating...';
            statusEl.style.color = '#64748b';
            
            fetch(`/admin/api/tas/${taId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ slug: newSlug })
            })
            .then(res => res.json())
            .then(result => {
                if (result.error) {
                    statusEl.textContent = result.error;
                    statusEl.style.color = '#ef4444';
                } else {
                    statusEl.textContent = 'URL updated successfully!';
                    statusEl.style.color = '#22c55e';
                    showTADetail(taId);
                }
            })
            .catch(err => {
                statusEl.textContent = 'Failed to update URL';
                statusEl.style.color = '#ef4444';
            });
        }
        
        loadTAs();
    </script>
</body>
</html>
